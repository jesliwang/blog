---
layout: post
color: deep-purple
title: "红雀增加实时对战的分析与讨论"
date:  2016-05-23 20:57:25+0800
categories: normal
---
# 红雀增加实时对战的分析与讨论
红雀战斗系统基于非严格的战斗控制，所以在实现联网对战的方式上有2种方式可走

## 方案一：采用服务器/客户端模式的表现控制
客户端接收操作指令，转发服务器处理。服务器处理完双方指令，调用表现切换

### 优点：
* 实现迅速，不需要修改原来的系统逻辑。仅仅在状态切换、打击判定、位置移动添加同步指令，对原有战斗系统不会改变

### 缺点：
+ 服务器和客户端的机器性能有差异，两边帧率有差距。会导致主/客的表现不一致
+ 操作同步问题。因为主/客的频率不一样，所以服务器在第K帧的操作，到客户端会变成K+i帧。因为网络延迟的不可控制，i是个变化的值。会导致服务器两临2帧的操作要么在一帧收到，要不收到的时间是两个非相邻的帧。导致主/客表现不一致

### 优化此种方式需要解决的问题
1. 提高游戏帧率。游戏帧率提高了，游戏发包频率就会提高。可以有效减少网络延迟导致的动画起始、终止时间不一致
2. 提高网络首发包速度。 网络首发包快了，可以向单机对战的方向改变
3. 1、2 导致的通信速度再快，毕竟2台机器，很难做到服务器和客户端的双向交互能在1帧完成。收益动作、位置的补偿纠正不可避免的要发生
4. 3d动画表现方式是动画插值。因为两边的帧率不一样，主/客的表现是不一样的。可能主/客表现的打击判定不一样

### 目前的机遇
unity5优化了网络同步，可以指定同步位置、动画等信息，不需要整体同步整个结构了。但是次方法同步数据量大，通信频率不能很高。同时基于unity的网络系统，目前情况做全网联机问题比较大。

## 方案二： 基于服务器/客户端模式的帧同步
客户端服务器互为主/客同步操作。每一次显示的刷新，都基于已经收到本机和远程机器的对本帧的操作指令。如果未收到双方指令，则显示不刷新。直到收到指令位置
这样循环流程成为   等待输入-》输入转化-》刷新显示

### 优点：
1. 战斗表现完全可以控制，同步想怎么来怎么来

### 缺点：
1. 显示刷新中加入了网络数据确认，动画的帧率要下降
2. 通信部流畅的时候，双方都会卡住

### 需要解决的问题：
1. 需要一套系统来主动sample战斗中的动画

### 现有的机遇：
1. 有现成的插件Universal Fighting Engine已经实现了主动控制动画表现
2. 现成的forge Networking插件，实现了网络通信功能
